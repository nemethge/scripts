#!/bin/bash

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#   First Boot Setup Script - Hostname + Static IP
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

set -e
set -o pipefail

# â”€â”€ Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   ðŸ›   Hostname & Static IP Configuration Script   â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo

# â”€â”€ 1. System Update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ðŸ“¦ Updating package lists and upgrading packages..."
sudo apt update -y && sudo apt upgrade -y
echo "âœ… System updated."
echo

# â”€â”€ 2. Hostname Configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
read -p "ðŸ‘‰ Enter the new hostname: " NEW_HOSTNAME

if [ -z "$NEW_HOSTNAME" ]; then
    echo "âŒ No hostname provided. Exiting."
    exit 1
fi

echo "ðŸ”§ Setting hostname to: $NEW_HOSTNAME"
sudo hostnamectl set-hostname "$NEW_HOSTNAME"

# Update /etc/hosts (only the 127.0.0.1 line)
sudo sed -i "s/^127\.0\.0\.1.*/127.0.0.1 localhost $NEW_HOSTNAME/" /etc/hosts

echo "âœ… Hostname successfully updated to: $(hostname)"
echo

# â”€â”€ 3. Detect Network Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ðŸŒ Detecting network settings..."
IFACE=$(ip -o -4 route show to default | awk '{print $5}')
IP_CIDR=$(ip -o -4 addr show "$IFACE" | awk '{print $4}')
IP_ADDR=$(echo "$IP_CIDR" | cut -d/ -f1)
SUBNET_MASK=$(echo "$IP_CIDR" | cut -d/ -f2)
GATEWAY=$(ip route | grep default | awk '{print $3}')

if [ -z "$IFACE" ] || [ -z "$IP_ADDR" ] || [ -z "$GATEWAY" ]; then
    echo "âŒ Failed to detect network settings. Exiting."
    exit 1
fi

echo "ðŸ“¡ Interface: $IFACE"
echo "ðŸ“Œ IP: $IP_ADDR/$SUBNET_MASK  |  Gateway: $GATEWAY"
echo

# â”€â”€ 4. Backup Interfaces File â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ðŸ“ Backing up /etc/network/interfaces..."
sudo cp /etc/network/interfaces /etc/network/interfaces.bak.$(date +%F_%H-%M-%S)
echo "âœ… Backup created."
echo

# â”€â”€ 5. Configure Static IP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ðŸ›  Applying static IP configuration..."
sudo tee /etc/network/interfaces > /dev/null <<EOL
# Autogenerated by setup script
auto lo
iface lo inet loopback

auto $IFACE
iface $IFACE inet static
    address $IP_ADDR
    netmask $SUBNET_MASK
    gateway $GATEWAY
EOL

# â”€â”€ 6. Restart Networking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ðŸ”„ Restarting networking service..."
if sudo systemctl restart networking; then
    echo "âœ… Static IP applied: $IP_ADDR"
else
    echo "âŒ Failed to restart networking."
    exit 1
fi

echo
echo "ðŸŽ‰ All done!"
echo "   â€¢ Hostname: $NEW_HOSTNAME"
echo "   â€¢ Static IP: $IP_ADDR"
echo
echo "ðŸ‘‰ Tip: Reconnect your SSH session to see the new hostname in the prompt."
